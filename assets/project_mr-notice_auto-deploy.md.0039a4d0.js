import{_ as s,o as n,c as a,a as l}from"./app.03463ea3.js";const A=JSON.parse('{"title":"\u9879\u76EE\u90E8\u7F72\u542F\u52A8","description":"","frontmatter":{},"headers":[{"level":2,"title":"1. \u670D\u52A1\u5668\u914D\u7F6E(centos)","slug":"_1-\u670D\u52A1\u5668\u914D\u7F6E-centos","link":"#_1-\u670D\u52A1\u5668\u914D\u7F6E-centos","children":[{"level":3,"title":"1. docker","slug":"_1-docker","link":"#_1-docker","children":[]},{"level":3,"title":"2. git","slug":"_2-git","link":"#_2-git","children":[]},{"level":3,"title":"3. node","slug":"_3-node","link":"#_3-node","children":[]},{"level":3,"title":"4. pm2","slug":"_4-pm2","link":"#_4-pm2","children":[]}]},{"level":2,"title":"2. \u542F\u52A8\u5404\u670D\u52A1","slug":"_2-\u542F\u52A8\u5404\u670D\u52A1","link":"#_2-\u542F\u52A8\u5404\u670D\u52A1","children":[{"level":3,"title":"1. mysql","slug":"_1-mysql","link":"#_1-mysql","children":[]},{"level":3,"title":"2. \u542F\u52A8\u540E\u7AEF\u670D\u52A1","slug":"_2-\u542F\u52A8\u540E\u7AEF\u670D\u52A1","link":"#_2-\u542F\u52A8\u540E\u7AEF\u670D\u52A1","children":[]},{"level":3,"title":"3. \u542F\u52A8nginx(\u6302\u8F7D\u6587\u4EF6)","slug":"_3-\u542F\u52A8nginx-\u6302\u8F7D\u6587\u4EF6","link":"#_3-\u542F\u52A8nginx-\u6302\u8F7D\u6587\u4EF6","children":[]},{"level":3,"title":"4. \u524D\u7AEF\u81EA\u52A8\u90E8\u7F72(github action)","slug":"_4-\u524D\u7AEF\u81EA\u52A8\u90E8\u7F72-github-action","link":"#_4-\u524D\u7AEF\u81EA\u52A8\u90E8\u7F72-github-action","children":[]}]}],"relativePath":"project/mr-notice/auto-deploy.md","lastUpdated":1667897211000}'),p={name:"project/mr-notice/auto-deploy.md"},e=l(`<h1 id="\u9879\u76EE\u90E8\u7F72\u542F\u52A8" tabindex="-1">\u9879\u76EE\u90E8\u7F72\u542F\u52A8 <a class="header-anchor" href="#\u9879\u76EE\u90E8\u7F72\u542F\u52A8" aria-hidden="true">#</a></h1><h2 id="_1-\u670D\u52A1\u5668\u914D\u7F6E-centos" tabindex="-1">1. \u670D\u52A1\u5668\u914D\u7F6E(centos) <a class="header-anchor" href="#_1-\u670D\u52A1\u5668\u914D\u7F6E-centos" aria-hidden="true">#</a></h2><h3 id="_1-docker" tabindex="-1">1. docker <a class="header-anchor" href="#_1-docker" aria-hidden="true">#</a></h3><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;"># \u6DFB\u52A0\u5B89\u88C5\u5305</span></span>
<span class="line"><span style="color:#A6ACCD;">sudo yum install -y yum-utils</span></span>
<span class="line"><span style="color:#676E95;"># \u8BBE\u7F6E\u955C\u50CF\u4ED3\u5E93</span></span>
<span class="line"><span style="color:#A6ACCD;">sudo yum-config-manager </span></span>
<span class="line"><span style="color:#A6ACCD;">--add-repo </span></span>
<span class="line"><span style="color:#A6ACCD;">http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span>
<span class="line"><span style="color:#676E95;"># \u5B89\u88C5\u524D\u5148\u66F4\u65B0yum\u8F6F\u4EF6\u5305\u7D22\u5F15</span></span>
<span class="line"><span style="color:#A6ACCD;">yum makecache fast</span></span>
<span class="line"><span style="color:#676E95;"># \u5B89\u88C5docker-ce\uFF08\u793E\u533A\u7248-\u514D\u8D39\u7684\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">sudo yum install docker-ce docker-ce-cli containerd.io</span></span>
<span class="line"><span style="color:#676E95;"># \u542F\u52A8docker</span></span>
<span class="line"><span style="color:#A6ACCD;">sudo systemctl start docker</span></span>
<span class="line"><span style="color:#676E95;"># \u9A8C\u8BC1</span></span>
<span class="line"><span style="color:#A6ACCD;">docker version</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_2-git" tabindex="-1">2. git <a class="header-anchor" href="#_2-git" aria-hidden="true">#</a></h3><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;"># \u66F4\u65B0yum\u7684git\u6E90</span></span>
<span class="line"><span style="color:#A6ACCD;">wget http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-1.noarch.rpm </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> rpm -ivh wandisco-git-release-7-1.noarch.rpm</span></span>
<span class="line"><span style="color:#676E95;"># \u5B89\u88C5</span></span>
<span class="line"><span style="color:#A6ACCD;">yum install git -y</span></span>
<span class="line"><span style="color:#676E95;"># \u9A8C\u8BC1</span></span>
<span class="line"><span style="color:#A6ACCD;">git --version</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_3-node" tabindex="-1">3. node <a class="header-anchor" href="#_3-node" aria-hidden="true">#</a></h3><p>\u5B89\u88C5\u5305(\u5982\u679C\u5B89\u88C5\u5305\u7248\u672C\u8FC7\u9AD8\u53EF\u80FD\u6709\u95EE\u9898)</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">wget https://nodejs.org/dist/v16.14.0/node-v16.14.0-linux-x64.tar.xz</span></span>
<span class="line"><span style="color:#676E95;"># \u89E3\u538B</span></span>
<span class="line"><span style="color:#A6ACCD;">tar xvf node-v16.14.0-linux-x64.tar.xz</span></span>
<span class="line"><span style="color:#676E95;"># \u6539\u540D\u4FBF\u4E8E\u540E\u7EED\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">mv node-v16.14.0-linux-x64.tar.xz nodejs</span></span>
<span class="line"><span style="color:#676E95;"># \u8F6F\u94FE\u63A5(\u4EE5\u4FBF\u53EF\u4EE5\u5728\u4EFB\u610F\u76EE\u5F55\u4E0B\u4F7F\u7528 node \u548C npm \u547D\u4EE4, \u7C7B\u4F3C\u5728windows\u4E0A\u914D\u7F6E\u5168\u5C40\u73AF\u5883\u53D8\u91CF)</span></span>
<span class="line"><span style="color:#A6ACCD;">ln -s /root/nodejs/bin/node /usr/local/bin/node</span></span>
<span class="line"><span style="color:#A6ACCD;">ln -s /root/nodejs/bin/npm /usr/local/bin/npm</span></span>
<span class="line"><span style="color:#A6ACCD;">ln -s /root/nodejs/bin/npx /usr/bin/npx</span></span>
<span class="line"><span style="color:#676E95;"># \u68C0\u67E5\u662F\u5426\u5B89\u88C5\u5B8C\u6210</span></span>
<span class="line"><span style="color:#A6ACCD;">node -v</span></span>
<span class="line"><span style="color:#A6ACCD;">npm -v</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_4-pm2" tabindex="-1">4. pm2 <a class="header-anchor" href="#_4-pm2" aria-hidden="true">#</a></h3><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;"># \u5B89\u88C5</span></span>
<span class="line"><span style="color:#A6ACCD;">npm i -g pm2</span></span>
<span class="line"><span style="color:#676E95;"># \u8F6F\u94FE</span></span>
<span class="line"><span style="color:#A6ACCD;">sudo ln -s /download/nodejs/bin/npx /usr/bin/npx</span></span>
<span class="line"><span style="color:#676E95;"># \u9A8C\u8BC1</span></span>
<span class="line"><span style="color:#A6ACCD;">pm2 -v</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_2-\u542F\u52A8\u5404\u670D\u52A1" tabindex="-1">2. \u542F\u52A8\u5404\u670D\u52A1 <a class="header-anchor" href="#_2-\u542F\u52A8\u5404\u670D\u52A1" aria-hidden="true">#</a></h2><h3 id="_1-mysql" tabindex="-1">1. mysql <a class="header-anchor" href="#_1-mysql" aria-hidden="true">#</a></h3><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">docker pull mysql:5.7</span></span>
<span class="line"><span style="color:#A6ACCD;">docker run -d --name=mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7</span></span>
<span class="line"><span style="color:#A6ACCD;">docker </span><span style="color:#82AAFF;">exec</span><span style="color:#A6ACCD;"> -it mysql bash</span></span>
<span class="line"><span style="color:#676E95;"># (\u5982\u679C\u767B\u5F55\u4EE5\u53CACREATE\u6B65\u9AA4\u62A5\u9519Operation CREATE USER failed for &#39;root&#39;@&#39;%&#39;, \u90A3\u4E48\u4F7F\u7528\u8FD9\u4E2A\u547D\u4EE4)</span></span>
<span class="line"><span style="color:#676E95;"># drop user &#39;root&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;">bash-4.2# mysql -u root -p 123456</span></span>
<span class="line"><span style="color:#676E95;"># \u6388\u6743</span></span>
<span class="line"><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">CREATE USER </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">@</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> IDENTIFIED BY </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">GRANT ALL ON </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">.</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> TO </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">@</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;"># \u5237\u65B0\u6743\u9650</span></span>
<span class="line"><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> flush privileges</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;"># \u4FEE\u6539root\u7528\u6237\u5BC6\u7801</span></span>
<span class="line"><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> ALTER USER </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">@</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> IDENTIFIED WITH mysql_native_password BY </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">123456</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;"># \u5237\u65B0\u6743\u9650</span></span>
<span class="line"><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> flush privileges</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_2-\u542F\u52A8\u540E\u7AEF\u670D\u52A1" tabindex="-1">2. \u542F\u52A8\u540E\u7AEF\u670D\u52A1 <a class="header-anchor" href="#_2-\u542F\u52A8\u540E\u7AEF\u670D\u52A1" aria-hidden="true">#</a></h3><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;"># \u4F7F\u7528pm2\u542F\u52A8</span></span>
<span class="line"><span style="color:#A6ACCD;">pm2 start main.js</span></span>
<span class="line"><span style="color:#676E95;"># \u67E5\u770B\u662F\u5426\u542F\u52A8\u6210\u529F</span></span>
<span class="line"><span style="color:#A6ACCD;">pm2 status</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u81EA\u52A8\u90E8\u7F72(\u914D\u5408github action)</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki"><code><span class="line"><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Node.js Package</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF9CAC;">on</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">push</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">branches</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">master</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">pull_request</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">branches</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">master</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">jobs</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">docker-deploy</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">runs-on</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ubuntu-latest</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">steps</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">connect serve and deploy</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">appleboy/ssh-action@v0.1.5</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">with</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\${{ secrets.REMOTE_HOST }}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\${{ secrets.REMOTE_PASSWORD }}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\${{ secrets.REMOTE_DEPLOY_SHELL }}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>\u4E3B\u8981\u539F\u7406\u662F\u8FDE\u63A5\u5BBF\u4E3B\u673A, \u8C03\u7528\u5BBF\u4E3B\u673A\u811A\u672C\u66F4\u65B0pm2\u8FDB\u7A0B \u4E0A\u8FF0\u7684\u53D8\u91CF\u5747\u4FDD\u5B58\u5728github\u4E0A</p><p>\u5BBF\u4E3B\u673A(\u670D\u52A1\u5668)\u4E0A\u7684\u811A\u672C<code>refresh-backend.sh</code></p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">#!/bin/bash</span></span>
<span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> /root/zk/project/mr-notice-backend </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> git fetch --all </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> git reset --hard origin/master </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> git pull</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[[</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-n</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#C3E88D;">pm2 show mr-notice-backend</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">]];</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">then</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">restart app mr-notice-backend...</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  pm2 restart mr-notice-backend</span></span>
<span class="line"><span style="color:#89DDFF;">else</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">start app &#39;mr-notice-backend&#39;...</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  pm2 start --name mr-notice-backend</span></span>
<span class="line"><span style="color:#89DDFF;">fi</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_3-\u542F\u52A8nginx-\u6302\u8F7D\u6587\u4EF6" tabindex="-1">3. \u542F\u52A8nginx(\u6302\u8F7D\u6587\u4EF6) <a class="header-anchor" href="#_3-\u542F\u52A8nginx-\u6302\u8F7D\u6587\u4EF6" aria-hidden="true">#</a></h3><p>\u5177\u4F53\u542F\u52A8\u9879\u76EE\u81EA\u5B9A\u4E49nginx\u7684\u914D\u7F6E\u5728\u4E0B\u4E00\u6761</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;"># \u542F\u52A8\u6807\u51C6nginx\u5BB9\u5668</span></span>
<span class="line"><span style="color:#A6ACCD;">docker pull nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">docker run -itd --name=nginx -p 80:80 nginx</span></span>
<span class="line"><span style="color:#676E95;"># \u590D\u5236\u6302\u8F7D\u6587\u4EF6\u6A21\u677F\u5230\u5BBF\u4E3B\u673A\u4E2D</span></span>
<span class="line"><span style="color:#A6ACCD;">mkdir nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">docker cp </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">\u5BB9\u5668id</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">:/etc/nginx/nginx.conf ./</span></span>
<span class="line"><span style="color:#A6ACCD;">docker cp </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">\u5BB9\u5668id</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">:/etc/nginx/conf.d/default.conf ./conf/</span></span>
<span class="line"><span style="color:#676E95;"># \u5220\u9664\u6807\u51C6\u5BB9\u5668</span></span>
<span class="line"><span style="color:#A6ACCD;">docker rm -f </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">\u5BB9\u5668id</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#676E95;"># \u914D\u7F6Enginx(\u81EA\u5DF1\u914D\u7F6E\u5373\u53EF)</span></span>
<span class="line"><span style="color:#A6ACCD;">vim ./conf/default.conf</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_4-\u524D\u7AEF\u81EA\u52A8\u90E8\u7F72-github-action" tabindex="-1">4. \u524D\u7AEF\u81EA\u52A8\u90E8\u7F72(github action) <a class="header-anchor" href="#_4-\u524D\u7AEF\u81EA\u52A8\u90E8\u7F72-github-action" aria-hidden="true">#</a></h3><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;"># This is a basic workflow to help you get started with Actions</span></span>
<span class="line"><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Auto deploy</span></span>
<span class="line"><span style="color:#676E95;"># Controls when the workflow will run</span></span>
<span class="line"><span style="color:#FF9CAC;">on</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># Triggers the workflow on push or pull request events but only for the main branch</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">push</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">branches</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">pull_request</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">branches</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># A workflow run is made up of one or more jobs that can run sequentially or in parallel</span></span>
<span class="line"><span style="color:#F07178;">jobs</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">docker-build</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># The type of runner that the job will run on</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">runs-on</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ubuntu-latest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># Steps represent a sequence of tasks that will be executed as part of the job</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">steps</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Login to DockerHub</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker/login-action@v2.1.0</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">with</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\${{ secrets.DOCKERHUB_USERNAME }}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\${{ secrets.DOCKERHUB_TOKEN }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Build and push Docker images</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker/build-push-action@v3.2.0</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">with</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">push</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">tags</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\${{ secrets.DOCKERHUB_USERNAME }}/mr-notice-frontend:latest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">docker-deploy</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">needs</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker-build</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">runs-on</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ubuntu-latest</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">steps</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">connect serve and deploy</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">appleboy/ssh-action@v0.1.5</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">with</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\${{ secrets.REMOTE_HOST }}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\${{ secrets.REMOTE_PASSWORD }}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\${{ secrets.REMOTE_DEPLOY_SHELL }}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>\u9996\u5148\u767B\u5F55\u5E76\u6253\u5305\u6700\u65B0\u9879\u76EE\u4E3Adocker\u955C\u50CF, \u63A8\u9001\u5230docker\u4ED3\u5E93, \u7136\u540E\u8FDE\u63A5\u5BBF\u4E3B\u673A, \u8C03\u7528\u5BBF\u4E3B\u673A\u811A\u672C\u66F4\u65B0\u524D\u7AEF\u5BB9\u5668 \u4E0A\u8FF0\u7684\u53D8\u91CF\u5747\u4FDD\u5B58\u5728github\u4E0A</p><p>\u5BBF\u4E3B\u673A(\u670D\u52A1\u5668)\u4E0A\u7684\u811A\u672C<code>refresh-front.sh</code></p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">refresh-front.sh</span></span>
<span class="line"><span style="color:#676E95;">#!/bin/bash</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[[</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-n</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#C3E88D;">docker ps -q -f </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">name=^mr-notice-frontend$</span><span style="color:#89DDFF;">&quot;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">]];</span><span style="color:#89DDFF;">then</span></span>
<span class="line"><span style="color:#A6ACCD;"> docker rm -f mr-notice-frontend</span></span>
<span class="line"><span style="color:#A6ACCD;"> docker pull 413365742/mr-notice-frontend:latest</span></span>
<span class="line"><span style="color:#89DDFF;">fi</span></span>
<span class="line"><span style="color:#A6ACCD;">docker run -itd --name mr-notice-frontend -p 80:80 -v /root/zk/deploy-dist/nginx-config/conf:/etc/nginx/conf.d 413365742/mr-notice-frontend:latest</span></span>
<span class="line"><span style="color:#A6ACCD;">docker image prune -a -f</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">success</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>docker\u7684\u591A\u9636\u6BB5\u6253\u5305\u6587\u4EF6\u5728\u9879\u76EE\u91CC\u9762</p>`,30),o=[e];function r(c,t,i,y,D,C){return n(),a("div",null,o)}const u=s(p,[["render",r]]);export{A as __pageData,u as default};
